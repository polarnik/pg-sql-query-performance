---
marp: true
title: Из слона (PostgreSQL) муху (баги)
description: Мониторинг, анализ и оптимизация SQL-запросов
theme: gaia
template: gaia
paginate: true
_paginate: false
---


# Из слона (PostgreSQL) муху (баги)
## Мониторинг, анализ и оптимизация SQL-запросов

Смирнов Вячеслав
ВТБ

<!--
История ускорения системы.
Про три месяца оформления и исправления дефектов большой системы,
которую можно услышать за тридцать минут и прожить за десять.

Как известно, инструмент подбирается под задачу.
Но для задачи визуализации статистики по SQL-запросам с точностью до минуты (или секунды, при желании) инструмента не было,
так чтобы инструмент работал в закрытой сети, работал под максимально высокой нагрузкой, не требовал модификаций PostgreSQL.
Инструмент был собран из открытых компонент: Telegraf, InfluxDB, Grafana. И отлично показал себя на проекте.
Позволив оформлять и исправлять дефекты в течение трех месяцев не отвлекаясь ни на что другое.
Что позволило достаточно быстро ускорить систему.

А если нужна детальная статистика с учетом значений параметров запроса, то это тоже возможно. За счет простого логирования и анализа лога.

Расскажу об опыте применения двух подходов к сбору и визуализации статистики, 
о том какие есть альтернативные подходы, которые не дали результата,
о том какие есть альтернативные решения, которыми вдохновлялся,
о том какие новые и полезные решения есть и появляются сейчас.

Аудитория и уровень

Доклад будет интересен инженерам по производительности и мониторингу систем, имеющим дело с PostgreSQL. Тем, кто стремиться не только тестировать и мониторить, но и оптимизировать, как саму систему так и механизм мониторинга.

Опыт оптимизации не требуется, но представление о том, что такое Java, SQL, PostgreSQL и Time Series Database нужно иметь.
-->

---

## Как я пришел к мониторингу PostgreSQL

- База данных выросла на продуктиве и стала узким местом, система замедлилась
- Все стали заниматься ускорением, но ускорения нет
- Замедлять систему непроверенным мониторингом нельзя
- Микросервисам не хватает пула подключений
- Подключений к PostgreSQL уже 10 000

---

## Нужен источник метрик по SQL-запросам

Но не простой срез статистики, а с удобным сравнением:

- Что определенный SQL-запрос ускорился на X процентов
- С хранением статистики за длительный интервал
- С гибким выбором интервалов для сравнения
- С высокой интенсивностью сбора метрик
- С быстрым отображением данных

---

## О чем доклад

- Как не раздуть из мухи слона в анализе производительности
- Или как написать дефект, от которого можно посчитать эффект
- Отображение за секунду месячной статистики по SQL
- Как и зачем выполнять трассировку SQL-запросов

---

## Рассказ о себе

<!-- 
Повышаю качество более десяти лет. Занимаюсь системой дистанционного банковского обслуживания юридических лиц. Основной профиль моей работы — тестирование производительности. Развиваю сообщество инженеров по тестированию производительности, помогая коллегам в telegram чате «QA — Load & Performance».
-->


---

## Цели инженера по производительности

* проверка того, что система может обрабатывать транзакции за определённое время
* повышение производительности настройкой, а не переписыванием, и выбор нужных настроек
* повышение производительности исправлением кода, а не закупкой аппаратной части, и предложение нужных правок
* устранение проблем производительности в продуктиве

---

## О роли инженера

#### Инженер по тестированию производительности ПО
Команда:
* "Мы поправили, проверь"
* "Когда-нибудь проанализируем"
* "Дефект больше не воспроизводится"

---

## О роли инженера

#### Инженер по производительности
Инженер:
* "Поправить предлагаю так, уже проверено"
* "Ускорение ключевой операции на 70%"

---

## О роли оптимизации SQL и роли инженера

* стенд разработки на Docker-контейнерах с малой БД
  * тут все запросы быстрые
* стенд нагрузки с большой БД со сгенерированными данными
  * долгие запросы (active) и выполняются иначе
  * долгие транзакции (idle in transaction)
  * нехватка подключений (idle)
  * блокировки (blocked)

---

## Наполнение большой БД с корретными данными

Отсылка к предыдущему докладу на CodeFest

---

## Как раздуть из мухи слона

#### При недостатке фактов
Инженер:
* "Поправить предлагаю так, <strike>уже проверено</strike>"
* "Ускорение <strike>ключевой операции на 70%</strike> будет"

Команда:
* "Поправили, но на DEV-стенде нет эффекта"

---

# Из слона (PostgreSQL) муху (дефект) 

### Дефект, от которого можно посчитать эффект

#### Долгие запросы (Active)

* Выбор наиболее медленных SQL-запросов
* Анализ интенсивности SQL-запроса
* Среднее и максимальное время
* Другие важные метрики

---

# Из слона (PostgreSQL) муху (дефект) 

### Дефект, от которого можно посчитать эффект

#### Долгие транзакции (Idle in transaction)

* Выбор SQL-запросов в долгих транзакциях
* Поиск кода, вызывающего SQL-запрос
* Анализ причин зависания

---

# Из слона (PostgreSQL) муху (дефект)

### Дефект, от которого можно посчитать эффект

#### Нехватка подключений (idle)

* Выбор сервисов с неиспользуемыми подключениями
* Справедливое распределение подключений
* Настройки времени жизни подключений

---

# Быстрое отображение статистики

### Отображение за секунду месячной статистики

* Как компактно хранить SQL-запросы в InfluxDB
* Как детализировать статистику по запросу
* Как сравнить статистику по двум тестам

---

# Как выполнять трассировку SQL

### Partial-индексы и вот это вот все

* Почему мы не знаем параметры
* Почему важно знать параметры
* Угадываем параметры
* Параметры из логов, трассировки и профилирования
* Примеры запросов и их параметров

---

## Как не раздуть из мухи слона, занимаясь тестами производительности


<!-- 
# Без разработчиков тестировщикам не обойтись.
Благодарю за инструменты:
- Apache.JMeter, Gatling, InfluxDB, Prometheus, Grafana, PostgreSQL

# Разработчикам не обойтись без тестировщиков

Если речь о выявлении медленных SQL-запросах, их анализе и оптимизации.

Разработчик хочет активно менять систему, поэтому стремиться запускать сервер баз данных в Docker, запускать систему с небольшой быстрой базой данных.

На таком окружении разработчик может найти проблемы производительности. Но далеко не все. Или совсем не те, что проявляются на нагрузочном или продуктовном стендах.

И поэтому если проблемы производительности ищет разработчик, а не тестировщик, то получается вот так.
-->





---

## Мониторинг SQL под нагрузкой и анализ результатов

- Мониторинг SQL
- Мониторинг SQL под высокой нагрузкой
- Возможность изменения интервала времени с точностью до минуты

---

## Мониторинг

- YourKit, JProfiler, коммерческие профайлеры
- APM, Application Performance Monitoring-системы
- ELK + DEBUG-логи приложения с медленными SQL-запросами
- PgBadger + логи PostgreSQL с медленными SQL-запросами
- коммерческие облачные системы мониторинга: okmeter.io
- pg_stats_statements и Prometheus PostgreSQL Exporter
- pg_stats_statements и Telegraf + InfluxDB
- pg_profile для сравнительных отчетов
- pg_stat_monitor для PostgreSQL 11+

