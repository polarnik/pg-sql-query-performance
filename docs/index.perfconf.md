---
marp: true
title: –ò–∑ —Å–ª–æ–Ω–∞ (PostgreSQL) –º—É—Ö—É (–±–∞–≥–∏)
description: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥, –∞–Ω–∞–ª–∏–∑ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
theme: perfconf
template: bespoke
paginate: true
_paginate: false

---

<!-- _class: lead2
_footer: 'C—Å—ã–ª–∫–∞ –Ω–∞ [—Å–ª–∞–π–¥—ã](https://polarnik.github.io/pg-sql-query-performance/index.perfconf.html), —Å—Å—ã–ª–∫–∞ [–Ω–∞ –ø—Ä–æ–µ–∫—Ç](https://github.com/polarnik/pg-sql-query-performance)'
-->

![ w:300px ](themes/img/lead/perf.png)

# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL,<br> —Ç–µ–æ—Ä–∏—è –∏ –ø—Ä–∞–∫—Ç–∏–∫–∞

## __–°–º–∏—Ä–Ω–æ–≤ –í—è—á–µ—Å–ª–∞–≤, 2021__

<!--




–ò—Å—Ç–æ—Ä–∏—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã.
–ü—Ä–æ —Ç—Ä–∏ –º–µ—Å—è—Ü–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ñ–µ–∫—Ç–æ–≤ –±–æ–ª—å—à–æ–π —Å–∏—Å—Ç–µ–º—ã,
–∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ —É—Å–ª—ã—à–∞—Ç—å –∑–∞ —Ç—Ä–∏–¥—Ü–∞—Ç—å –º–∏–Ω—É—Ç –∏ –ø—Ä–æ–∂–∏—Ç—å –∑–∞ –¥–µ—Å—è—Ç—å.

–ö–∞–∫ –∏–∑–≤–µ—Å—Ç–Ω–æ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ–¥ –∑–∞–¥–∞—á—É.
–ù–æ –¥–ª—è –∑–∞–¥–∞—á–∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ SQL-–∑–∞–ø—Ä–æ—Å–∞–º —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ –º–∏–Ω—É—Ç—ã (–∏–ª–∏ —Å–µ–∫—É–Ω–¥—ã, –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏) –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–µ –±—ã–ª–æ,
—Ç–∞–∫ —á—Ç–æ–±—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–ª –≤ –∑–∞–∫—Ä—ã—Ç–æ–π —Å–µ—Ç–∏, —Ä–∞–±–æ—Ç–∞–ª –ø–æ–¥ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π, –Ω–µ —Ç—Ä–µ–±–æ–≤–∞–ª –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–π PostgreSQL.
–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –±—ã–ª —Å–æ–±—Ä–∞–Ω –∏–∑ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç: Telegraf, InfluxDB, Grafana. –ò –æ—Ç–ª–∏—á–Ω–æ –ø–æ–∫–∞–∑–∞–ª —Å–µ–±—è –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ.
–ü–æ–∑–≤–æ–ª–∏–≤ –æ—Ñ–æ—Ä–º–ª—è—Ç—å –∏ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –¥–µ—Ñ–µ–∫—Ç—ã –≤ —Ç–µ—á–µ–Ω–∏–µ —Ç—Ä–µ—Ö –º–µ—Å—è—Ü–µ–≤ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—è—Å—å –Ω–∏ –Ω–∞ —á—Ç–æ –¥—Ä—É–≥–æ–µ.
–ß—Ç–æ –ø–æ–∑–≤–æ–ª–∏–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä–æ —É—Å–∫–æ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É.

–ê –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —É—á–µ—Ç–æ–º –∑–Ω–∞—á–µ–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞, —Ç–æ —ç—Ç–æ —Ç–æ–∂–µ –≤–æ–∑–º–æ–∂–Ω–æ. –ó–∞ —Å—á–µ—Ç –ø—Ä–æ—Å—Ç–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–∞.

–†–∞—Å—Å–∫–∞–∂—É –æ–± –æ–ø—ã—Ç–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–≤—É—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –∫ —Å–±–æ—Ä—É –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏, 
–æ —Ç–æ–º –∫–∞–∫–∏–µ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –¥–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞,
–æ —Ç–æ–º –∫–∞–∫–∏–µ –µ—Å—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–º–∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–ª—Å—è,
–æ —Ç–æ–º –∫–∞–∫–∏–µ –Ω–æ–≤—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –µ—Å—Ç—å –∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–µ–π—á–∞—Å.

–ê—É–¥–∏—Ç–æ—Ä–∏—è –∏ —É—Ä–æ–≤–µ–Ω—å

–î–æ–∫–ª–∞–¥ –±—É–¥–µ—Ç –∏–Ω—Ç–µ—Ä–µ—Å–µ–Ω –∏–Ω–∂–µ–Ω–µ—Ä–∞–º –ø–æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É —Å–∏—Å—Ç–µ–º, –∏–º–µ—é—â–∏–º –¥–µ–ª–æ —Å PostgreSQL. –¢–µ–º, –∫—Ç–æ —Å—Ç—Ä–µ–º–∏—Ç—å—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å, –Ω–æ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –∫–∞–∫ —Å–∞–º—É —Å–∏—Å—Ç–µ–º—É —Ç–∞–∫ –∏ –º–µ—Ö–∞–Ω–∏–∑–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

–û–ø—ã—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ —Ç–∞–∫–æ–µ Java, SQL, PostgreSQL –∏ Time Series Database –Ω—É–∂–Ω–æ –∏–º–µ—Ç—å.
-->

---

<!-- _class: title-->

# –¢–µ—Å—Ç–∏—Ä—É—é –∏ —É—Å–∫–æ—Ä—è—é –î–ë–û –¥–ª—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü –≤ –±–∞–Ω–∫–µ –í–¢–ë
## __–†–∞–∑–≤–∏–≤–∞—é @qa_load__

![bg cover](img/omsk.jpg)

<!-- 
–ü–æ–≤—ã—à–∞—é –∫–∞—á–µ—Å—Ç–≤–æ –±–æ–ª–µ–µ –¥–µ—Å—è—Ç–∏ –ª–µ—Ç. –ó–∞–Ω–∏–º–∞—é—Å—å —Å–∏—Å—Ç–µ–º–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü. –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ñ–∏–ª—å –º–æ–µ–π —Ä–∞–±–æ—Ç—ã ‚Äî —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –†–∞–∑–≤–∏–≤–∞—é —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –∏–Ω–∂–µ–Ω–µ—Ä–æ–≤ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –ø–æ–º–æ–≥–∞—è –∫–æ–ª–ª–µ–≥–∞–º –≤ telegram —á–∞—Ç–µ ¬´QA ‚Äî Load & Performance¬ª.
-->

---
<!-- _class: main
-->

# –û–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL –≥–ª–∞–∑–∞–º–∏ –∏–Ω–∂–µ–Ω–µ—Ä–∞ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–∞–≥—Ä—É–∑–∫–∏

![ w:300px ](themes/img/lead/perf.png)

---
<!-- class: head2 -->

# –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1) –ö–æ–≥–¥–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤–∞–∂–Ω–∞
2) –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –µ–≥–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å
3) –ù–∞—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –±–∞–∑–µ Telegraf, InfluxDB, Grafana, Selenium, Jenkins

6) –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
4) –ß–µ–∫-–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∞–∂–Ω–µ–µ –¥—Ä—É–≥–∏—Ö
5) –°–æ—Å—Ç–∞–≤ –¥–µ—Ñ–µ–∫—Ç–∞ –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é –∑–∞–ø—Ä–æ—Å–∞
5) –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π –∏ –æ–ø—ã—Ç–∞

---
<!-- _class: main
-->

# –ö–æ–≥–¥–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤–∞–∂–Ω–∞

![ w:300px ](themes/img/lead/perf.png)

---

# –í—ã—Å–æ–∫–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è CPU –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö


**_![  ](img2/cpu.usage.png)_**

–ú–µ—Ç—Ä–∏–∫–∏:

- Load Average > 2
- CPU Usage > 80%

---

# –°—É–º–º–∞—Ä–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –ø–æ–ª–∫–µ

**_![  ](img2/db.totaltime.png)_**

–í–≤–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

- –ú–∏–Ω—É—Ç–∞ —Ä–∞–±–æ—Ç—ã –ë–î
- –°–µ—Ä–≤–µ—Ä —Å 20-—é CPU Core

–ù–∞–±–ª—é–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

- –°—É–º–º–∞—Ä–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 
SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –æ–∫–æ–ª–æ 
20-—Ç–∏ –º–∏–Ω—É—Ç
–∑–∞ 1 –º–∏–Ω—É—Ç—É

---

# –ù–µ—Ö–≤–∞—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ –ª–æ–≥–∞—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## __HikariPool: Connection is not available__

## __Unable to acqure JDBC Connection__

**_![  ](img2/Connection.error.png)_**

–†–∞–∑–ª–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ 
–Ω–µ—Ö–≤–∞—Ç–∫–∏ 
–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

---
<!-- _class: main
-->

# –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –µ–≥–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å
![ w:300px ](themes/img/lead/perf.png)

---

# –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ–¥ –∑–∞–¥–∞—á—É

## __–ö–∞–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç —Ä–µ—à–∏—Ç—å:__

- –í—ã–±–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞

- –ü–æ–∏—Å–∫ –≥–æ—Ç–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤, –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∑–∞–ø—Ä–æ—Å–æ–≤
- –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø–æ–¥–±–æ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤
- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞

---

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pg_stat_statements

## __–í –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º –≤–∏–¥–µ —Å–±—Ä–æ—Å–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç –∑–∞ —Ç–µ—Å—Ç__

–°–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:

```sql
select pg_stat_statements_reset()
```
–í—ã–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞:
```sql
select * from pg_stat_statements 
```
> –ù—É–∂–Ω—ã –ø—Ä–∞–≤–∞ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Å–±—Ä–æ—Å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
---

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pg_stat_statements

## __–í –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º –≤–∏–¥–µ –Ω—É–∂–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å —Ä–∞–∑–Ω–∏—Ü—É –º–µ—Ç—Ä–∏–∫ –∑–∞ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞__

–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ (start) –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è (stop):

```sql
select * into stat_start from pg_stat_statements 
select * into stat_stop from pg_stat_statements 
```
–í—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–∏—Ä–∞—â–µ–Ω–∏–µ –ø–æ QueryID:
```sql
select b.total_time - a.total_time as t, b.queryid, b.query
from stat_stop b join stat_start a
on (b.queryid = a.queryid)
order by t DESC
```

---

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ pg_stat_statements

## __–í –∏–¥–µ–∞–ª–µ, –µ—Å—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥__

**_![  ](img/top.2.png)_**

- –≤ Grafana

- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
- —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
- —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

### –û–∫–æ–ª–æ 1 –º–µ—Å—è—Ü–∞ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫—É




---

# Confluence, Wiki

## __–ü–æ–∏—Å–∫ –≥–æ—Ç–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ QueryID__

__*![  ](img2/report.png)*__ 

–£–¥–æ–±–Ω–æ –≤–µ—Å—Ç–∏ –æ—Ç—á–µ—Ç—ã
—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
–∞–Ω–∞–ª–∏–∑–∞

–î–ª—è –∫–∞–∂–¥–æ–≥–æ QueryID
–∏–∑ TOP-5 –¥–µ–ª–∞—Ç—å
–æ–ø–∏—Å–∞–Ω–∏–µ –∏–ª–∏ –¥–µ—Ñ–µ–∫—Ç


### Confluence –±–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –∫–æ–º–∞–Ω–¥ –¥–æ 10-—Ç–∏ —á–µ–ª–æ–≤–µ–∫. –ê –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ–º–∞–Ω–¥ –±–æ–ª—å—à–æ–π –±—é–¥–∂–µ—Ç


---

# DBeaver

## __–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–æ–¥–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤__

__*![  ](img2/dbeaver.png)*__ 

- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ $1, $2, ...
- –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞
```sql
explain 
(analize, buffers)
```

### DBeaver Community Edition –±–µ—Å–ø–ª–∞—Ç–µ–Ω

---

# JProfiler, SublimeText, Excel

## __–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∑–∞–ø—Ä–æ—Å–∞__

__*![  ](img2/JProfiler.png)*__ 

JProfiler –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å 
–ø–∞—Ä–∞–º–µ—Ç—Ä—ã SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ 
–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

### JProfiler: $499 + 20% –ù–î–° SublimeText: $65 –≤ –≥–æ–¥ 

---

# DBeaver, PGAdmin 4, explain.tensor.ru

## __–ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø–æ–¥–±–æ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤__

__*![  ](img2/explain.png)*__ 

### –ë–µ—Å–ø–ª–∞—Ç–Ω–æ

---

# DBeaver, Jira

## __–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞__

__*![  ](img2/bug.png)*__ 

### Jira —Å—Ç–æ–∏—Ç –º–Ω–æ–≥–æ. –ù–æ –æ–Ω–∞, –æ–±—ã—á–Ω–æ, –µ—Å—Ç—å

---
<!-- _class: main
-->

# –ù–∞—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞ –±–∞–∑–µ Telegraf, InfluxDB, Grafana, Selenium, Jenkins

![ w:300px ](themes/img/lead/perf.png)

---


![bg](img/pgstat.1.png)


---

<!-- _class: title -->

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–ø—Ä–æ—Å–∞–º –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü

## __–° —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º__

![bg brightness:0.5](img/pgstat.2.png)

---

<!-- _class: title -->

# –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É

## __–ò –Ω–µ —Ç–æ–ª—å–∫–æ —ç—Ç–æ__

![bg brightness:0.5](img/pgstat.3.png)


---

<!-- _class: title -->

# https://github.com/ polarnik/pg-sql-query-performance

## __–ü—Ä–æ–µ–∫—Ç —Å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–µ–π__

![bg right:45% h:70% ](img/sql-qrcode.svg)

---


# –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–µ–∫—Ç

```bash
# –û—Ç–¥–µ–ª—å–Ω–æ –ø–æ–¥–Ω—è—Ç—å —Å–µ—Ä–≤–µ—Ä –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
docker-compose up db

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ–¥–Ω—è—Ç—ã–π —Å–µ—Ä–≤–µ—Ä –ë–î
# <Ctrl+C> –∏–ª–∏ –∫–æ–º–∞–Ω–¥–æ–π
docker stop sql_monitor_postgres

# –ê —Ç–µ–ø–µ—Ä—å –ø–æ–¥–Ω—è—Ç—å –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
docker-compose up

# –û—Ç–∫—Ä—ã—Ç—å Grafana
open 'http://localhost:3000'
```

![bg right:45% h:70% ](img/sql-qrcode.svg)

---
<!-- _class: main
-->

# –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é SQL-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∏—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
![ w:300px ](themes/img/lead/perf.png)

---

# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## __Grafana, Selenium, Confluence__
## __–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏__

**_![ ](img2/snapshot.png)_**


---

# –í—ã–±–æ—Ä TOP-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑

## __Grafana, Confluence__
## __–í—Ä—É—á–Ω—É—é__
## __2-6 —á–∞—Å–æ–≤__

**_![  ](img/top.4.png)_**

---

# –í—ã–±–æ—Ä TOP-–∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ Total Time


![  bg ](img/top.4.png)

---

![bg](img/query.4.png)


---

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤—Ä—É—á–Ω—É—é)

## __DBeaver__


**_![ ](img/explain.png)_**


### –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–æ–¥–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ $1. –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± ‚Äî —É–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã WHERE

---

# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

## __[auto_explain](https://www.postgresql.org/docs/10/auto-explain.html) –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è__
## __[pgBadger](https://github.com/darold/pgbadger) –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤__
## __–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏__

habr.com/ru/post/354948
–∞–≤—Ç–æ—Ä: @SanSYS
—Ñ–æ—Ç–æ pgBadger –∏–∑ —Å—Ç–∞—Ç—å–∏

### auto_explain –∏ pgBadger –±–µ—Å–ø–ª–∞—Ç–Ω—ã, –Ω–æ –Ω—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º PostgreSQL

**_![ ](img2/auto_explain.png)_**

---

# –ü–µ—Ä–µ—Ö–≤–∞—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## __–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç__
## __–í–∫–ª—é—á–∏—Ç—å JProfiler__

## __–û–±—Ä–∞–±–æ—Ç–∫–∞ csv –≤ Sublime__
## __–ê–Ω–∞–ª–∏–∑ csv –≤ Excel__

**_![ ](img2/JProfiler.png)_**

---

# –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ –ø–æ–¥–±–æ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

## __–≤ explain.tensor.ru (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)__
## __–≤ DBeaver –∏–ª–∏ PGAdmin 4__

**_![ ](img2/explain.png)_**

---

# –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞

## __Jira__

**_![ ](img2/bug.png)_**

---

# –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## __2 –¥–Ω—è (–Ω–∞ –æ–¥–∏–Ω –¥–µ—Ñ–µ–∫—Ç)__

–ï—Å–ª–∏ –±–µ–∑ –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è

## __3 –¥–Ω—è (–Ω–∞ –æ–¥–∏–Ω –¥–µ—Ñ–µ–∫—Ç)__

–° –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

| –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ä—É—á–Ω—ã–µ | üë®‚Äçüíª | ‚öíÔ∏è  |
| :------: | :---: | :----: | 
| –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ | ‚öôÔ∏è | Grafana, Selenium  |
| –í—ã–±–æ—Ä TOP-–∑–∞–ø—Ä–æ—Å–æ–≤, –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ | üñêÔ∏è | Grafana, Confluence | 
| –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ | üñêÔ∏è | DBeaver, PGAdmin| 1 |
| –°–±–æ—Ä –ø–ª–∞–Ω–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ | ‚öôÔ∏è | auto_explain | |
| _–ü–µ—Ä–µ—Ö–≤–∞—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏—è)_ | _üñêÔ∏è_ | _JProfiler_ | _6_ |
| _–ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏—è)_ | _üñêÔ∏è_ | _SublimeText, Excel_ | _2_ |
| –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π | ‚öôÔ∏è | explain.tensor.ru | 2 |
| –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π | üñêÔ∏è | DBeaver, PGAdmin | 4 |
| –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –¥–µ—Ñ–µ–∫—Ç–∞ | üñêÔ∏è | Jira | 2 |



---

# –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º–∞—Å—Å–æ–≤–æ–π –Ω–∞—á–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏

## __3 –¥–Ω—è (–Ω–∞ –≥—Ä—É–ø–ø—É –¥–µ—Ñ–µ–∫—Ç–æ–≤) –¥–ª—è –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞__

* –ë–µ–∑ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é

* –ë–µ–∑ –æ–ø—ã—Ç–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤
* –î–µ–π—Å—Ç–≤—É—è –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º




---

| _#_ | –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç –¥–ª—è –æ–¥–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ | üë®‚Äçüíª | ‚öíÔ∏è |
|---| :------: | :---: | :----: | 
| _1_ | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ | ‚òëÔ∏è‚öôÔ∏è | Grafana, Selenium |
| _2_ | –í—ã–±–æ—Ä TOP-–∑–∞–ø—Ä–æ—Å–æ–≤, –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ | ‚òëÔ∏èüñêÔ∏è | Grafana, Confluence |
| _3_ | –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ | ‚òëÔ∏èüñêÔ∏è | DBeaver, auto_explain | 
| _4_ | –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –±–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ | ‚òëÔ∏èüñêÔ∏è | Jira |
|_5_| _–ü–µ—Ä–µ—Ö–≤–∞—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏—è)_ | _üë®‚Äçüè´üñêÔ∏è_ | _Jenkins, JProfiler_ | 
|_6_| _–ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏—è)_ | _üë®‚Äçüè´üñêÔ∏è_ | _SublimeText, Excel_ |
|_7_| _–ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π_ | _üë®‚Äçüè´‚öôÔ∏è_ | _explain.tensor.ru_ | 
|_8_| _–ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π_ | _üë®‚Äçüè´üñêÔ∏è_ | _DBeaver, PGAdmin_ | 
|_9_| _–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ –¥–µ—Ñ–µ–∫—Ç_ | _üë®‚Äçüè´üñêÔ∏è_ | _Jira_ | 

---

# –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

## __–ï—â—ë 1-3 –¥–Ω—è (–Ω–∞ –≥—Ä—É–ø–ø—É –¥–µ—Ñ–µ–∫—Ç–æ–≤) —É–∂–µ –¥–ª—è –¥–≤—É—Ö —á–µ–ª–æ–≤–µ–∫__

* –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

* –í–æ–∑–º–æ–∂–Ω–æ, —Å–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –±—É–¥–µ—Ç –¥–æ–ª–≥–∏–º

> –£ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –æ–±—ã—á–Ω–æ, –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
–∏ –Ω–µ—Ç —Å—Ç–µ–Ω–¥–∞ —Å –±–æ–ª—å—à–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

---

| _#_ | –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç –¥–ª—è –¥–≤—É—Ö —á–µ–ª–æ–≤–µ–∫ | üë®‚Äçüè´üë®‚Äçüíª | ‚öíÔ∏è |
|---| :------: | :---: | :----: | 
|_1_| _–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞_ | _‚òëÔ∏è‚öôÔ∏è_ | _Grafana, Selenium_ |
|_2_| _–í—ã–±–æ—Ä TOP-–∑–∞–ø—Ä–æ—Å–æ–≤, –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑_ | _‚òëÔ∏èüñêÔ∏è_ | _Grafana, Confluence_ |
| _3_ | _–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ/–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞_ | _‚òëÔ∏èüñêÔ∏è_ | _DBeaver, auto_explain_ | 
|_4_| _–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –±–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏_ | _‚òëÔ∏èüñêÔ∏è_ | _Jira_ |
|_5_| –ü–µ—Ä–µ—Ö–≤–∞—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏—è) | üë®‚Äçüè´üñêÔ∏è | Jenkins, JProfiler | 
|_6_| –ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ (–æ–ø—Ü–∏—è) | üë®‚Äçüè´üñêÔ∏è | SublimeText, Excel |
|_7_| –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π | üë®‚Äçüè´‚öôÔ∏è | explain.tensor.ru | 
|_8_| –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π | üë®‚Äçüè´üñêÔ∏è | DBeaver, PGAdmin | 
|_9_|  –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –≤ –¥–µ—Ñ–µ–∫—Ç | üë®‚Äçüè´üñêÔ∏è | Jira | 



---
<!-- _class: main
-->

# –ß–µ–∫-–ª–∏—Å—Ç –∞–Ω–∞–ª–∏–∑–∞ –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–∞–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∞–∂–Ω–µ–µ –¥—Ä—É–≥–∏—Ö
![ w:300px ](themes/img/lead/perf.png)

---

# TOP-–∑–∞–ø—Ä–æ—Å—ã: –ø–æ Total Time


![  bg ](img2/stat.total.png)

---

# –ù–µ—Ö–≤–∞—Ç–∫–∞ –∏–Ω–¥–µ–∫—Å–∞: (SharedHit+SharedRead)/Count

![  bg ](img2/stat.shared.png)

---

# ¬´N+1 select problem¬ª: –¥–∏—Å–ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ Count

![  bg ](img2/stat.count.png)

---
<!-- _class: main
-->

# –°–æ—Å—Ç–∞–≤ –¥–µ—Ñ–µ–∫—Ç–∞ –ø–æ —É—Å–∫–æ—Ä–µ–Ω–∏—é –∑–∞–ø—Ä–æ—Å–∞
![ w:300px ](themes/img/lead/perf.png)

---

# –ó–∞–≥–æ–ª–æ–≤–æ–∫

[–°–ï–†–í–ò–°] –ù–µ–æ–±—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤ —Ç–∞–±–ª–∏—Ü–µ –¢–ê–ë–õ–ò–¶–ê –ø–æ –ø–æ–ª—é –ü–û–õ–ï –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ TOP-111 –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ QUERY_ID SharedHit 11111, SharedRead 2222

> –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç –Ω–∞–π—Ç–∏ –¥–µ—Ñ–µ–∫—Ç—ã, –≤–µ–¥—å –∏—Ö –±—É–¥–µ—Ç –º–Ω–æ–≥–æ


# [auth] –ù–µ–æ–±—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –≤ —Ç–∞–±–ª–∏—Ü–µ auth_users –ø–æ –ø–æ–ª—é id –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ TOP-1 auth_user 987987128 SharedHit 901, SharedRead 20


---

# –û–∫—Ä—É–∂–µ–Ω–∏–µ

```
–ù–∞–≥—Ä—É–∑–æ—á–Ω—ã–π —Å—Ç–µ–Ω–¥ LOAD-2
–≤–µ—Ä—Å–∏—è auth 1.1.1.8
```

> –ü—Ä–æ—Å—Ç–æ —Ö–æ—Ä–æ—à–∏–π —Ç–æ–Ω

---

# –ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å

```
–ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å TOP-1 auth_user (+ —Å—Å—ã–ª–∫–∞ –Ω–∞ Grafana)
```

![](img2/Test_638_Defect_top7_image.jpg)


---

# –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞

```sql
delete from lnp.npanxx_block
    where status isnull
    and (npanxx, block_id) not in (
        select
            npanxx,
            block_id
        from lnp.npanxx_block_source
        where status isnull
    )
    returning 1
```

---

# –ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```sql
Delete on npanxx_block  (cost=0.00..81967834804.63 rows=612435 width=6)
  ->  Seq Scan on npanxx_block  
      (cost=0.00..81967834804.63 rows=612435 width=6)
        Filter: ((status IS NULL) AND (NOT (SubPlan 1)))
        SubPlan 1
          ->  Materialize  (cost=0.00..128977.33 rows=1255870 width=8)
                ->  Seq Scan on npanxx_block_source  
                    (cost=0.00..117791.98 rows=1255870 width=8)
                      Filter: (status IS NULL)
```

---

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –∏–Ω–¥–µ–∫—Å

```sql
create index fix1_AUTH_7654_npanxx_block_partial_idx
on npanxx_block(id)
where (status IS NULL);


create index fix2_AUTH_7654_npanxx_block_source_partial_idx
on npanxx_block_source(id)
where (status IS NULL);

```

> –ú–æ–∂–Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å

---

# –ü–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞

```sql
Delete on npanxx_block  (cost=0.00..11967834.63 rows=612435 width=6)
  ->  Index Scan using fix1_AUTH_7654_npanxx_block_partial_idx 
      on npanxx_block  
      (cost=0.00..11967834.63 rows=612435 width=6)
        Filter: (NOT (SubPlan 1))
        SubPlan 1
          ->  Materialize  (cost=0.00..128977.33 rows=1255870 width=8)
                ->  Index Scan using fix2_AUTH_7654_npanxx_block_source_partial_idx 
                    on npanxx_block_source  
                    (cost=0.00..117.98 rows=1255870 width=8)
```
> –ú–æ–∂–Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω—è—Ç—å

---

# –ë—ã–ª–æ / –°—Ç–∞–ª–æ

–ë—ã–ª–æ:
```sql
Delete on npanxx_block  (cost=0.00..81967834804.63)
```
–°—Ç–∞–ª–æ:
```sql
Delete on npanxx_block  (cost=0.00..11967834.63)
```
> –í–∞–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–∫—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫–∞–º–∏

---

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

–†–∞–±–æ—Ç–∞ —Å–µ—Ä–≤–∏—Å–∞ auth –≤–æ –≤—Ä–µ–º—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —É—Å–∫–æ—Ä–∏—Ç—Å—è. –ü—Ä–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–∞ —Å—Ç–µ–Ω–¥–µ load-2

–ú–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å —É—Å–∫–æ—Ä–∏—Ç—Å—è: 
* ShredHit –ø–æ –∑–∞–ø—Ä–æ—Å—É –±—ã–ª 2222222, —Å—Ç–∞–Ω–µ—Ç 2

–ü–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —É–¥–∞–ª–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã
* fix1_AUTH_7654_npanxx_block_partial_idx
* fix2_AUTH_7654_npanxx_block_source_partial_idx

> –û—á–µ–Ω—å –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—É—Å—Ç–æ–π –ë–î

---
<!-- _class: main
-->

# –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π –∏ –æ–ø—ã—Ç–∞
![ w:300px ](themes/img/lead/perf.png)

---

# postgrespro.ru/education/courses

–û–ø–∏—Å–∞–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –∫–æ–º–∞–Ω–¥—ã PostgresPro

# edu.postgrespro.ru

–°–∞–º–∏ –∫—É—Ä—Å—ã

# github.com/polarnik/pg-sql-query-performance

–î–µ–º–æ —Å—Ç–µ–Ω–¥ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–∞

---
<!-- class: head2 -->

# –í—ã–≤–æ–¥—ã

1) –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ —É—Ç–∏–ª–∏–∑–∞—Ü–∏—é CPU –∏ –æ—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î
2) –ü–æ—á—Ç–∏ –≤—Å–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –±–µ—Å–ø–ª–∞—Ç–Ω—ã, auto_explain —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –ø–æ–¥–±–æ—Ä–∞ –ø–ª–∞–Ω–∞, explain.tensor.ru —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤—Ä–µ–º—è –∞–Ω–∞–ª–∏–∑–∞
3) –†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—Ä–∞–±–æ—Ç–∫–∏ github.com/polarnik/pg-sql-query-performance

6) –†–∞–±–æ—Ç—ã —Å—Ç–æ–∏—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –¥–≤–∞ —ç—Ç–∞–ø–∞ –ø–æ 3 –¥–Ω—è: —Å–Ω–∞—á–∞–ª–∞ –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤ 
4) –û–±—Ä–∞—â–∞–π—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ TotalTime, SharedHit –∏ –Ω–∞ Count
5) –î–æ–±–∞–≤–ª—è–π—Ç–µ –ø–ª–∞–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ—Ñ–µ–∫—Ç –∏ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏
5) –û–±—É—á–∞–π—Ç–µ—Å—å –Ω–∞ postgrespro.ru/education/

---

<!-- _class: lead2
-->

# –í–æ–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã<br> –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ PostgreSQL

## __–°–º–∏—Ä–Ω–æ–≤ –í—è—á–µ—Å–ª–∞–≤, @qa_load__
![ w:300px ](themes/img/lead/perf.png)



